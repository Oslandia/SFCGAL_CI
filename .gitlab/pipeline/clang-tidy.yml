test:clang-tidy:
  stage: lint
  image: xianpengshen/clang-tools:19
  variables:
    CC: /usr/bin/clang-19
    CXX: /usr/bin/clang++-19
  cache:
    policy: pull
    key: "${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/
  before_script:
    - apt-get update -qq
    - apt-get install -y --no-install-recommends git wget cmake make python3 ca-certificates build-essential pkg-config
    - ./ci/debian/before_install.sh $CGAL_LATEST_VERSION
    - CGAL_DIR=$CI_PROJECT_DIR/CGAL cmake -S . -B build \
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
        -DSFCGAL_BUILD_TESTS=ON \
        -DCMAKE_C_COMPILER=${CC} \
        -DCMAKE_CXX_COMPILER=${CXX}
    - ls build
  script:
    - git fetch --depth 1 origin $CI_MERGE_REQUEST_DIFF_BASE_SHA
    - TIDY_DIFF="$(command -v clang-tidy-diff-19.py || command -v clang-tidy-diff.py)"
    - |
      git diff -U0 $CI_MERGE_REQUEST_DIFF_BASE_SHA $CI_COMMIT_SHA \
        '***.cpp' '***.hpp' '***.c' '***.h' \
      | python3 "$TIDY_DIFF" -p1 \
          -path=build \
          -use-color \
          -clang-tidy-binary /usr/bin/clang-tidy-19 \
          -export-fixes=errors.yml || true
    - test -f errors.yml || touch errors.yml
    - exit $(grep -ic "warning" errors.yml)
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "src/**/*.{c,h,cpp,hpp}"
        - ".clang-tidy"
        - "test/.clang-tidy"
  artifacts:
    when: on_failure
    paths:
      - errors.yml
